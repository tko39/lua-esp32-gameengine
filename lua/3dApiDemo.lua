math.randomseed(millis() % 1000000)

local FOV = 220
local CAM_DISTANCE = 180
local RADIUS = 70 -- 2D radius on screen

lge.set_3d_camera(FOV, CAM_DISTANCE)
lge.set_3d_light(0, 1, -1, 0.2, 0.8)

local SCREEN_W, SCREEN_H = lge.get_canvas_size()

local vertices = {0.158052, -0.322091, 0.491270, 0.158052, -0.322091, -0.158117, 0.158052, 0.323392, -0.158117,
                  0.158052, 0.323392, 0.491270, -0.164299, -0.322091, 0.491270, -0.164299, -0.322091, -0.158117,
                  -0.164299, 0.323392, 0.491270, -0.164299, 0.323392, -0.158117, 0.186682, -0.167227, 0.933738,
                  0.186682, -0.167227, 0.621407, 0.186682, 0.155514, 0.621407, 0.186682, 0.155514, 0.933738, -0.186682,
                  -0.167227, 0.933738, -0.186682, -0.167227, 0.621407, -0.186682, 0.155514, 0.933738, -0.186682,
                  0.155514, 0.621407, 0.145038, -0.320789, -0.288255, 0.145038, -0.320789, -0.933738, 0.145038,
                  -0.062596, -0.933738, 0.145038, -0.062596, -0.288255, -0.148812, -0.320789, -0.288255, -0.148812,
                  -0.320789, -0.933738, -0.148812, -0.062596, -0.288255, -0.148812, -0.062596, -0.933738, 0.155449,
                  -0.514694, 0.491270, 0.155449, -0.514694, -0.158117, 0.155449, -0.322091, -0.158117, 0.155449,
                  -0.322091, 0.491270, -0.167682, -0.514694, 0.491270, -0.167682, -0.514694, -0.158117, -0.167682,
                  -0.322091, 0.491270, -0.167682, -0.322091, -0.158117, 0.160655, 0.320789, 0.491270, 0.160655,
                  0.320789, -0.158117, 0.160655, 0.514694, -0.158117, 0.160655, 0.514694, 0.491270, -0.161436, 0.320789,
                  0.491270, -0.161436, 0.320789, -0.158117, -0.161436, 0.514694, 0.491270, -0.161436, 0.514694,
                  -0.158117, 0.059148, -0.064158, 0.621407, 0.059148, -0.064158, 0.491270, 0.059148, 0.064809, 0.491270,
                  0.059148, 0.064809, 0.621407, -0.069689, -0.064158, 0.621407, -0.069689, -0.064158, 0.491270,
                  -0.069689, 0.064809, 0.621407, -0.069689, 0.064809, 0.491270, 0.158052, -0.324693, -0.158117,
                  0.158052, -0.324693, -0.288255, 0.158052, 0.319488, -0.288255, 0.158052, 0.319488, -0.158117,
                  -0.164559, -0.324693, -0.158117, -0.164559, -0.324693, -0.288255, -0.164559, 0.319488, -0.158117,
                  -0.164559, 0.319488, -0.288255, 0.160655, 0.061165, -0.288255, 0.160655, 0.061165, -0.933738,
                  0.160655, 0.319488, -0.933738, 0.160655, 0.319488, -0.288255, -0.161436, 0.061165, -0.288255,
                  -0.161436, 0.061165, -0.933738, -0.161436, 0.319488, -0.288255, -0.161436, 0.319488, -0.933738}

local faces = {1, 2, 3, 1, 3, 4, 5, 6, 2, 5, 2, 1, 7, 8, 6, 7, 6, 5, 4, 3, 8, 4, 8, 7, 7, 5, 1, 7, 1, 4, 2, 6, 8, 2, 8,
               3, 9, 10, 11, 9, 11, 12, 13, 14, 10, 13, 10, 9, 15, 16, 14, 15, 14, 13, 12, 11, 16, 12, 16, 15, 15, 13,
               9, 15, 9, 12, 10, 14, 16, 10, 16, 11, 17, 18, 19, 17, 19, 20, 21, 22, 18, 21, 18, 17, 23, 24, 22, 23, 22,
               21, 20, 19, 24, 20, 24, 23, 23, 21, 17, 23, 17, 20, 18, 22, 24, 18, 24, 19, 25, 26, 27, 25, 27, 28, 29,
               30, 26, 29, 26, 25, 31, 32, 30, 31, 30, 29, 28, 27, 32, 28, 32, 31, 31, 29, 25, 31, 25, 28, 26, 30, 32,
               26, 32, 27, 33, 34, 35, 33, 35, 36, 37, 38, 34, 37, 34, 33, 39, 40, 38, 39, 38, 37, 36, 35, 40, 36, 40,
               39, 39, 37, 33, 39, 33, 36, 34, 38, 40, 34, 40, 35, 41, 42, 43, 41, 43, 44, 45, 46, 42, 45, 42, 41, 47,
               48, 46, 47, 46, 45, 44, 43, 48, 44, 48, 47, 47, 45, 41, 47, 41, 44, 42, 46, 48, 42, 48, 43, 49, 50, 51,
               49, 51, 52, 53, 54, 50, 53, 50, 49, 55, 56, 54, 55, 54, 53, 52, 51, 56, 52, 56, 55, 55, 53, 49, 55, 49,
               52, 50, 54, 56, 50, 56, 51, 57, 58, 59, 57, 59, 60, 61, 62, 58, 61, 58, 57, 63, 64, 62, 63, 62, 61, 60,
               59, 64, 60, 64, 63, 63, 61, 57, 63, 57, 60, 58, 62, 64, 58, 64, 59}

-- Create model in C++ renderer
local MODEL_ID = lge.create_3d_model(vertices, faces)

-- Build a simple repeating palette. Blue's are bad for 3-3-2 color representation (8-bit)
local palette = {"#00ff00", "#ff0000", "#ffff00"}

-- Per-triangle colors
local tri_colors = {}
local face_count = #faces / 3
for i = 1, face_count do
    tri_colors[i] = palette[(i - 1) % #palette + 1]
end

-- Create one instance of the model
local INSTANCE_ID = lge.create_3d_instance(MODEL_ID, tri_colors)

-- Animation state
local angle_x = 0
local angle_y = 0
local angle_z = 0

local d_ax = 0.015
local d_ay = 0.02
local d_az = 0.007

local function main_loop()
    while true do
        lge.clear_canvas("#000000")

        -- Spin
        angle_x = angle_x + d_ax
        angle_y = angle_y + d_ay
        angle_z = angle_z + d_az

        -- Draw imported model
        lge.draw_3d_instance(INSTANCE_ID, 0, 0, CAM_DISTANCE, RADIUS, angle_x, angle_y, angle_z)

        -- Overlay FPS
        local fps = lge.fps()
        fps = math.floor(fps * 100 + 0.5) / 100
        lge.draw_text(5, 5, "OBJ model FPS: " .. fps, "#FFFFFF")

        lge.present()
        lge.delay(1)
    end
end

main_loop()
